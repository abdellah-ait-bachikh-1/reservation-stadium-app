// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "mysql"
}

model User {
  id          String   @id @default(uuid())
  fullNameFr  String
  fullNameAr  String
  email       String   @unique
  password    String
  approved    Boolean  @default(false)
  role        UserRole @default(CLUB)
  phoneNumber String

  emailVerifiedAt   DateTime?
  verificationToken String?   @unique @default(uuid())
  preferredLocale UserLocale @default(AR) // AR, FR, EN

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  club              Club?
  reservations      Reservation[]
  reservationSeries ReservationSeries[]
  cashPayments      CashPaymentRecord[]
  monthlyPayments   MonthlyPayment[]
  subscriptions     MonthlySubscription[]
  notifications     Notification[]  // As receiver
  sentNotifications Notification[] @relation("NotificationActor") // As actor

  @@index([email])
  @@index([role])
  @@index([approved])
  @@index([createdAt])
  @@map("users")
}

model Club {
  id            String  @id @default(uuid())
  nameAr        String
  nameFr        String
  addressFr     String
  addressAr     String
  monthlyFee    Decimal @default(100) @db.Decimal(10, 2)
  paymentDueDay Int     @default(5)

  // Relations
  userId  String @unique
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  sportId String
  sport   Sport  @relation(fields: [sportId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([userId])
  @@index([sportId])
  @@index([nameFr])
  @@index([nameAr])
  @@map("clubs")
}

model Sport {
  id     String @id @default(uuid())
  nameAr String
  nameFr String

  // Relations
  clubs         Club[]
  stadiumSports StadiumSport[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([nameFr])
  @@index([nameAr])
  @@map("sports")
}

model Stadium {
  id              String  @id @default(uuid())
  nameAr          String
  nameFr          String
  addressFr       String
  addressAr       String
  googleMapsUrl   String
  monthlyPrice    Decimal @db.Decimal(10, 2)
  pricePerSession Decimal @db.Decimal(10, 2)

  // Relations
  images            StadiumImage[]
  stadiumSports     StadiumSport[]
  reservations      Reservation[]
  reservationSeries ReservationSeries[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([nameFr])
  @@index([nameAr])
  @@index([monthlyPrice])
  @@index([pricePerSession])
  @@map("stadiums")
}

model StadiumSport {
  stadiumId String
  sportId   String

  // Relations
  stadium Stadium @relation(fields: [stadiumId], references: [id], onDelete: Cascade)
  sport   Sport   @relation(fields: [sportId], references: [id], onDelete: Cascade)

  @@id([stadiumId, sportId])
  @@map("stadium_sports")
}

model StadiumImage {
  id        String @id @default(uuid())
  imageUri  String
  stadiumId String

  // Relations
  stadium Stadium @relation(fields: [stadiumId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([stadiumId])
  @@map("stadium_images")
}

model Reservation {
  id            String            @id @default(uuid())
  startDateTime DateTime
  endDateTime   DateTime
  status        ReservationStatus @default(PENDING)
  sessionPrice  Decimal           @db.Decimal(10, 2)
  isPaid        Boolean           @default(false)
  paymentType   PaymentType

  // Relations
  stadiumId           String
  stadium             Stadium            @relation(fields: [stadiumId], references: [id])
  userId              String
  user                User               @relation(fields: [userId], references: [id])
  monthlyPaymentId    String?
  monthlyPayment      MonthlyPayment?    @relation(fields: [monthlyPaymentId], references: [id])
  cashPayment         CashPaymentRecord?
  reservationSeriesId String?
  reservationSeries   ReservationSeries? @relation(fields: [reservationSeriesId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([startDateTime])
  @@index([endDateTime])
  @@index([status])
  @@index([userId])
  @@index([stadiumId])
  @@index([monthlyPaymentId])
  @@index([reservationSeriesId])
  @@index([createdAt])
  @@index([isPaid])
  @@index([startDateTime, stadiumId]) // For checking availability
  @@index([status, startDateTime]) // For filtering by status and date
  @@map("reservations")
}

model ReservationSeries {
  id                String      @id @default(uuid())
  startTime         DateTime // Use DateTime for time storage
  endTime           DateTime // Use DateTime for time storage
  dayOfWeek         Int // 1=Monday, 7=Sunday
  recurrenceEndDate DateTime?
  isFixed           Boolean     @default(true)
  billingType       BillingType
  monthlyPrice      Decimal?    @db.Decimal(10, 2)
  pricePerSession   Decimal?    @db.Decimal(10, 2)

  // Relations
  stadiumId       String
  stadium         Stadium              @relation(fields: [stadiumId], references: [id])
  userId          String
  user            User                 @relation(fields: [userId], references: [id])
  reservations    Reservation[]
  monthlyPayments MonthlyPayment[]
  subscription    MonthlySubscription?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([stadiumId])
  @@index([dayOfWeek])
  @@index([billingType])
  @@index([createdAt])
  @@index([recurrenceEndDate])
  @@index([startTime, endTime]) // For time-based queries
  @@map("reservation_series")
}

model MonthlyPayment {
  id            String        @id @default(uuid())
  month         Int
  year          Int
  amount        Decimal       @db.Decimal(10, 2)
  status        PaymentStatus @default(PENDING)
  paymentDate   DateTime?
  receiptNumber String?

  // Relations
  userId              String
  user                User               @relation(fields: [userId], references: [id])
  reservationSeriesId String
  reservationSeries   ReservationSeries  @relation(fields: [reservationSeriesId], references: [id])
  cashPayment         CashPaymentRecord?
  reservations        Reservation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([month, year, reservationSeriesId]) // Unique monthly payment per series
  @@index([userId])
  @@index([reservationSeriesId])
  @@index([status])
  @@index([month, year])
  @@index([paymentDate])
  @@index([createdAt])
  @@map("monthly_payments")
}

model CashPaymentRecord {
  id            String   @id @default(uuid())
  amount        Decimal  @db.Decimal(10, 2)
  paymentDate   DateTime @default(now())
  receiptNumber String
  notes         String?

  // Relations
  reservationId    String?
  reservation      Reservation?    @relation(fields: [reservationId], references: [id])
  monthlyPaymentId String?
  monthlyPayment   MonthlyPayment? @relation(fields: [monthlyPaymentId], references: [id])
  userId           String
  user             User            @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([reservationId])
  @@unique([monthlyPaymentId])
  @@index([userId])
  @@index([reservationId])
  @@index([monthlyPaymentId])
  @@index([paymentDate])
  @@index([createdAt])
  @@map("cash_payment_records")
}

model MonthlySubscription {
  id            String             @id @default(uuid())
  startDate     DateTime           @default(now())
  endDate       DateTime?
  monthlyAmount Decimal            @db.Decimal(10, 2)
  status        SubscriptionStatus @default(ACTIVE)
  autoRenew     Boolean            @default(true)

  // Relations
  userId              String
  user                User              @relation(fields: [userId], references: [id])
  reservationSeriesId String            @unique
  reservationSeries   ReservationSeries @relation(fields: [reservationSeriesId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([reservationSeriesId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([createdAt])
  @@map("monthly_subscriptions")
}

model Notification {
  id        String   @id @default(uuid())
  type      NotificationType
  
  titleEn   String   // English title
  titleFr   String   // French title
  titleAr   String   // Arabic title
  messageEn String   // English message
  messageFr String   // French message  
  messageAr String   // Arabic message*

  isRead    Boolean  @default(false)
  userId    String  // Receiver ID
  actorUserId   String?  // Who performed the action (optional)
  metadata  Json? // For additional dynamic data
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  actor     User?    @relation("NotificationActor", fields: [actorUserId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([actorUserId])
  @@index([userId, isRead])
  @@index([createdAt])
  @@index([type])
  @@map("notifications")
}
enum NotificationType {
  // Account related
  ACCOUNT_CREATED
  ACCOUNT_APPROVED
  ACCOUNT_REJECTED
  PROFILE_UPDATED
  PASSWORD_CHANGED

  // Reservation related
  RESERVATION_REQUESTED
  RESERVATION_APPROVED
  RESERVATION_DECLINED
  RESERVATION_CANCELLED
  RESERVATION_REMINDER

  // Payment related
  PAYMENT_RECEIVED
  PAYMENT_OVERDUE
  PAYMENT_FAILED
  PAYMENT_REFUNDED
  MONTHLY_SUBSCRIPTION_PAYMENT

  // System related
  SYSTEM_MAINTENANCE
  SYSTEM_UPDATE
  NEW_FEATURE
  ANNOUNCEMENT

  // Club related
  CLUB_REGISTRATION_SUBMITTED
  CLUB_REGISTRATION_APPROVED
  CLUB_REGISTRATION_REJECTED

  // Email related
  EMAIL_SENT
  EMAIL_VERIFIED
  WELCOME_EMAIL

  // Admin notifications
  NEW_USER_REGISTERED
  NEW_RESERVATION_REQUEST
  PAYMENT_REQUIRES_ATTENTION
}


// =====================
// Enums
// =====================
enum UserRole {
  ADMIN
  CLUB
}

enum ReservationStatus {
  PENDING
  APPROVED
  DECLINED
  CANCELLED
  PAID
  UNPAID
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  PARTIALLY_PAID
}

enum PaymentType {
  SINGLE_SESSION
  MONTHLY_SUBSCRIPTION
}

enum BillingType {
  PER_SESSION
  MONTHLY_SUBSCRIPTION
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  SUSPENDED
}

enum UserLocale {
  EN
  FR
  AR
}